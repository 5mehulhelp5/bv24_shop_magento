<?php
/**
 * Copyright © 2016 Magento. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

/** @var $block \Magento\Checkout\Block\Cart\Item\Renderer */

$_item = $block->getItem();
$product = $_item->getProduct();

// DEBUG: Produkt vollständig laden
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$productRepository = $objectManager->get('\Magento\Catalog\Api\ProductRepositoryInterface');
try {
    $fullProduct = $productRepository->getById($product->getId());
    echo "<!-- Produkt vollständig geladen: ID " . $fullProduct->getId() . " -->";
} catch (\Exception $e) {
    echo "<!-- FEHLER beim Laden: " . $e->getMessage() . " -->";
    $fullProduct = $product;
}

$isVisibleProduct = $product->isVisibleInSiteVisibility();
/** @var \Magento\Msrp\Helper\Data $helper */
$helper = $this->helper('Magento\Msrp\Helper\Data');
$canApplyMsrp = $helper->isShowBeforeOrderConfirm($product) && $helper->isMinimalPriceLessMsrp($product);

// Einheitspreisberechnung - wie in final_price.phtml
// DEBUG: Produktinformationen ausgeben
echo "<!-- DEBUG CART ITEM -->";
echo "<!-- Product ID: " . $product->getId() . " -->";
echo "<!-- Product SKU: " . $product->getSku() . " -->";

// Verwende das vollständig geladene Produkt
$productToUse = isset($fullProduct) ? $fullProduct : $product;

$inhalt = $productToUse->getData('inhalt');
echo "<!-- Inhalt (direkt): " . var_export($inhalt, true) . " -->";
if (!$inhalt) {
    $data = $productToUse->getData();
    if (isset($data['document_source']['inhalt'])) {
        $inhaltArr = $data['document_source']['inhalt'];
        $inhalt = is_array($inhaltArr) ? $inhaltArr[0] : $inhaltArr;
        echo "<!-- Inhalt (document_source): " . var_export($inhalt, true) . " -->";
    }
}
$inhalt = (float) $inhalt;
echo "<!-- Inhalt (final): " . $inhalt . " -->";

$grundeinheit = $productToUse->getData('grundeinheit');
echo "<!-- Grundeinheit (direkt): " . var_export($grundeinheit, true) . " -->";
if (!$grundeinheit) {
    $data = $productToUse->getData();
    if (isset($data['document_source']['grundeinheit'])) {
        $grundeinheitArr = $data['document_source']['grundeinheit'];
        $grundeinheit = is_array($grundeinheitArr) ? $grundeinheitArr[0] : $grundeinheitArr;
        echo "<!-- Grundeinheit (document_source): " . var_export($grundeinheit, true) . " -->";
    }
}
$grundeinheit = (float) $grundeinheit;
echo "<!-- Grundeinheit (final): " . $grundeinheit . " -->";

$verpackungseinheit = $productToUse->getAttributeText('verpackungseinheit');
echo "<!-- Verpackungseinheit (direkt): " . var_export($verpackungseinheit, true) . " -->";
if (!$verpackungseinheit) {
    $data = $productToUse->getData();
    if (isset($data['document_source']['option_text_verpackungseinheit'])) {
        $verpackungseinheitArr = $data['document_source']['option_text_verpackungseinheit'];
        $verpackungseinheit = is_array($verpackungseinheitArr) ? $verpackungseinheitArr[0] : $verpackungseinheitArr;
        echo "<!-- Verpackungseinheit (document_source): " . var_export($verpackungseinheit, true) . " -->";
    }
}
$verpackungseinheit_singuar = $verpackungseinheit ? trim(preg_split('/[\(\/]/', $verpackungseinheit)[0]) : '';
echo "<!-- Verpackungseinheit (singular): " . var_export($verpackungseinheit_singuar, true) . " -->";

$masseinheit = $productToUse->getAttributeText('masseinheit');
echo "<!-- Masseinheit (direkt): " . var_export($masseinheit, true) . " -->";
if (!$masseinheit) {
    $data = $productToUse->getData();
    if (isset($data['document_source']['option_text_masseinheit'])) {
        $masseinheitArr = $data['document_source']['option_text_masseinheit'];
        $masseinheit = is_array($masseinheitArr) ? $masseinheitArr[0] : $masseinheitArr;
        echo "<!-- Masseinheit (document_source): " . var_export($masseinheit, true) . " -->";
    }
}
echo "<!-- Masseinheit (final): " . var_export($masseinheit, true) . " -->";

// Preis pro Einheit berechnen
$preis = (float) $_item->getPrice();
echo "<!-- Preis: " . $preis . " -->";
$preisProEinheit = null;
if ($inhalt > 0 && $grundeinheit > 0) {
    $preisProEinheit = round($preis / ($inhalt * $grundeinheit), 2);
    echo "<!-- Preis pro Einheit: " . $preisProEinheit . " -->";
} else {
    echo "<!-- WARNUNG: Einheitspreis kann nicht berechnet werden (Inhalt: " . $inhalt . ", Grundeinheit: " . $grundeinheit . ") -->";
}
echo "<!-- /DEBUG CART ITEM -->";
?>
<tbody class="cart item">
    <tr class="item-info">
        <td data-th="<?php echo $block->escapeHtml(__('Item')); ?>" class="col item">
            <div class="cart-column-item-wrapper">
                <div class="item-control">
                    <?php /* @escapeNotVerified */ echo $block->getActions($_item) ?>
                </div>
                <?php if ($block->hasProductUrl()):?>
                <a href="<?php /* @escapeNotVerified */ echo $block->getProductUrl() ?>"
                   title="<?php echo $block->escapeHtml($block->getProductName()) ?>"
                   tabindex="-1"
                   class="product-item-photo">
                    <?php else:?>
                    <span class="product-item-photo">
            <?php endif;?>
            <?php echo $block->getImage($block->getProductForThumbnail(), 'cart_page_product_thumbnail')->toHtml(); ?>
            <?php if ($block->hasProductUrl()):?>
                </a>
            <?php else: ?>
                </span>
            <?php endif; ?>
                <div class="product-item-details">
                    <strong class="product-item-name">
                        <?php if ($block->hasProductUrl()):?>
                            <a href="<?php /* @escapeNotVerified */ echo $block->getProductUrl() ?>"><?php echo $block->escapeHtml($block->getProductName()) ?></a>
                        <?php else: ?>
                            <?php echo $block->escapeHtml($block->getProductName()) ?>
                        <?php endif; ?>
                    </strong>
                    <?php if ($_options = $block->getOptionList()):?>
                        <dl class="item-options">
                            <?php foreach ($_options as $_option) : ?>
                                <?php $_formatedOptionValue = $block->getFormatedOptionValue($_option) ?>
                                <dt><?php echo $block->escapeHtml($_option['label']) ?></dt>
                                <dd>
                                    <?php if (isset($_formatedOptionValue['full_view'])): ?>
                                        <?php /* @escapeNotVerified */ echo $_formatedOptionValue['full_view'] ?>
                                    <?php else: ?>
                                        <?php /* @escapeNotVerified */ echo $_formatedOptionValue['value'] ?>
                                    <?php endif; ?>
                                </dd>
                            <?php endforeach; ?>
                        </dl>
                    <?php endif;?>
                    <?php if ($messages = $block->getMessages()): ?>
                        <?php foreach ($messages as $message): ?>
                            <div class="cart item message <?php /* @escapeNotVerified */ echo $message['type'] ?>"><div><?php echo $block->escapeHtml($message['text']) ?></div></div>
                        <?php endforeach; ?>
                    <?php endif; ?>
                    <?php $addInfoBlock = $block->getProductAdditionalInformationBlock(); ?>
                    <?php if ($addInfoBlock): ?>
                        <?php echo $addInfoBlock->setItem($_item)->toHtml() ?>
                    <?php endif;?>
                </div>
            </div>
        </td>

        <?php if ($canApplyMsrp): ?>
            <td class="col msrp" data-th="<?php echo $block->escapeHtml(__('Price')); ?>">
                <span class="pricing msrp">
                    <span class="msrp notice"><?php /* @escapeNotVerified */ echo __('See price before order confirmation.'); ?></span>
                    <?php $helpLinkId = 'cart-msrp-help-' . $_item->getId(); ?>
                    <a href="#" class="action help map" id="<?php /* @escapeNotVerified */ echo($helpLinkId); ?>" data-mage-init='{"addToCart":{"helpLinkId": "#<?php /* @escapeNotVerified */ echo $helpLinkId;?>","productName": "<?php /* @escapeNotVerified */ echo $product->getName(); ?>","showAddToCart": false}}'>
                        <span><?php /* @escapeNotVerified */ echo __("What's this?"); ?></span>
                    </a>
                </span>
            </td>
        <?php else: ?>
            <td class="col price" data-th="<?php echo $block->escapeHtml(__('Price')); ?>">
                <div class="cart-price-wrapper">
                    <?php echo $block->getUnitPriceHtml($_item); ?>
                    <span><?php echo __('/ %1', $verpackungseinheit_singuar) ?></span>

                    <?php if ($preisProEinheit !== null): ?>
                        <div class="cart-unit-price">
                            <span class="price-per-unit">
                                <?= __('%1 €', number_format($preisProEinheit, 2, ',', '.')) ?>
                            </span>
                            <span class="price-unit">
                                <?= __('/ %1', $masseinheit) ?>
                            </span>
                            <?php if ($verpackungseinheit_singuar && $inhalt): ?>
                                <div class="price-per-unit-hint">
                                    <?= __('(%1 %2 / %3)', $inhalt, $masseinheit, $verpackungseinheit_singuar) ?>
                                </div>
                            <?php endif; ?>
                        </div>
                    <?php endif; ?>
                </div>
            </td>
        <?php endif; ?>
        <td class="col qty" data-th="<?php echo $block->escapeHtml(__('Qty')); ?>">
            <div class="field qty">
                <label class="label" for="cart-<?php /* @escapeNotVerified */ echo $_item->getId() ?>-qty">
                    <span><?php /* @escapeNotVerified */ echo __('Qty') ?></span>
                </label>
                <div class="control qty">
                    <input id="cart-<?php /* @escapeNotVerified */ echo $_item->getId() ?>-qty"
                           name="cart[<?php /* @escapeNotVerified */ echo $_item->getId() ?>][qty]"
                           data-cart-item-id="<?php /* @escapeNotVerified */ echo $_item->getSku() ?>"
                           value="<?php /* @escapeNotVerified */ echo $block->getQty() ?>"
                           type="number"
                           size="4"
                           title="<?php echo $block->escapeHtml(__('Qty')); ?>"
                           class="input-text qty"
                           maxlength="12"
                           data-validate="{required:true,'validate-greater-than-zero':true}"
                           data-role="cart-item-qty"/>
                </div>
            </div>
        </td>

        <td class="col subtotal" data-th="<?php echo $block->escapeHtml(__('Subtotal'));?>">
            <?php if ($canApplyMsrp): ?>
                <span class="cart msrp subtotal">--</span>
            <?php else: ?>
                <?php echo $block->getRowTotalHtml($_item); ?>
            <?php endif; ?>
        </td>
    </tr>
</tbody>
